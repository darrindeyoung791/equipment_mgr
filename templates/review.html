{% extends "base.html" %}

{% block content %}
<h2>设备借用审批</h2>

<div class="mt-4">
    {% if pending_records %}
    <div class="table-responsive">
        <table class="table table-bordered">
            <thead>
                <tr>
                    <th>申请学生</th>
                    <th>设备名称</th>
                    <th>型号</th>
                    <th>所属实验室</th>
                    <th>申请日期</th>
                    <th>操作</th>
                </tr>
            </thead>
            <tbody>
                {% for record, device, user in pending_records %}
                <tr>
                    <td>{{ user.name }} ({{ user.dpt }})</td>
                    <td>{{ device.device_name }}</td>
                    <td>{{ device.model }}</td>
                    <td>{{ device.lab }}</td>
                    <td>{{ record.borrow_date }}</td>
                    <td>
                        <button class="btn btn-sm btn-primary" 
                                onclick="showApprovalForm('{{ record.record_id }}')">
                            审批
                        </button>
                        <div id="form-{{ record.record_id }}" class="review-form" style="display: none;">
                            <form action="{{ url_for('approve_request', record_id=record.record_id) }}" method="post">
                                <div class="form-group">
                                    <label>审批结果：</label>
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="approval_status" value="2" id="approve-{{ record.record_id }}" required>
                                        <label class="form-check-label" for="approve-{{ record.record_id }}">
                                            批准
                                        </label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="approval_status" value="3" id="reject-{{ record.record_id }}" required>
                                        <label class="form-check-label" for="reject-{{ record.record_id }}">
                                            拒绝
                                        </label>
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label for="comment-{{ record.record_id }}">审批意见：</label>
                                    <textarea class="form-control" id="comment-{{ record.record_id }}" 
                                            name="comment" rows="3"></textarea>
                                </div>
                                <button type="submit" class="btn btn-primary">提交</button>
                            </form>
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% else %}
    <div class="alert alert-info">
        当前没有待审批的设备借用申请。
    </div>
    {% endif %}
</div>

<script>
function showApprovalForm(recordId) {
    const formElement = document.getElementById(`form-${recordId}`);
    if (formElement.style.display === 'none') {
        formElement.style.display = 'block';
    } else {
        formElement.style.display = 'none';
    }
}
</script>
{% endblock %}